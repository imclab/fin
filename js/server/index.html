<html>
	<head>
		<script type="text/javascript" src="../../lib/js.io/packages/jsio.js"></script>
		<script type="text/javascript" src="./fin.js"></script>
		<style type="text/css">
			body { 
				width: 900px; 
				margin: 40px auto; 
				font-family: Helvetica;
				font-size: 18px;
				color: #333;
				text-align: center;
			}
			#monitor {
				color: #383838;
				font-family: monospace;
				font-size: 13px;
				font-weight: bold;
				margin: 20px 0;
				overflow-x: hidden;
				text-align: left;
				width: 900px;
			}
		</style>
		
	</head>
	<body>
		This is a fin server, in your browser. Yup.
		<br /><br />
		Fin is all javascript. Even the server can run in a browser.
		<br /><br />
		Click the buttons to open clients. They'll connect using postmessage.
		<br /><br />
		<div id="buttons"></div>
		<div id="monitor"></div>
		
		<script>
		jsio.path.browser = '../../js'
		jsio('import browser.ItemLocalStore')
		jsio('import browser.ItemSetLocalStore')
		
		var server = fin.startServer({ 
			itemStore: new browser.ItemLocalStore(),
			itemSetStore: new browser.ItemSetLocalStore()
		})
		
		var postMessageListener = net.listen(server, 'postmessage')
		
		onload = function() {
			var dir = '../../', postfix = '#fin-postmessage'
			function addButton(page) {
				var button = postMessageListener.getButton(dir + page + postfix, page)
				button.style.display = 'block'
				button.style.margin = 'auto'
				document.getElementById('buttons').appendChild(button)
			}
			addButton('examples/from-html.html')
			addButton('examples/property-chain.html')
		}
		
		var oldOnMessage = postMessageListener._onMessage
		postMessageListener._onMessage = function(evt) {
			oldOnMessage.apply(postMessageListener, arguments)
			
			var monitor = document.getElementById('monitor')
			var data = eval('(' + evt.data + ')')
			var msg = data.type + (data.payload ? ': ' + data.payload : '')
			monitor.innerHTML = msg + '<hr />' + monitor.innerHTML
		}
		</script>
	</body>
</html>
