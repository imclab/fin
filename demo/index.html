<html>
	<head>
		<title>fin - create, query, subscribe, mutate</title>
		<style type="text/css">
			body { margin: 50px; padding: 0; color: #333; font-family: helvetica; }
			.column { width: 350px; float: left; margin: 3px; }
			.column .output { border: 2px solid #555; padding: 5px }
			.column .output .item { font-size: 11px; }
			.header { padding: 6px; border: 2px solid #555; margin-bottom: 8px; }
			.header input { width: 50px; }
			.button-holder { margin-top: 5px;}
			button { font-family: 'courier new'; font-size: 15px; margin: 2px; }
			input { border: 1px solid #333; padding: 1px 3px; position: relative; bottom: 1px; text-align: center;}
			.query-container div { margin-bottom: 2px; }
			.query-container span { font-size: 12px; }
		</style>
	</head>
	<body>
		<h1>fin</h1>
		<h2>never pull again</h2>
		<div style="clear: both;">
		<div id="create-column" class="column">
			<div class="header">API</div>
			<div id="create-header" class="header">
				<div class="label"><strong>create</strong> item with
					<input id="create-prop-input" value='type'></input>
					=
					<input id="create-val-input" value='user'></input>
				</div>
				<div class="button-holder"><button id="create-button">fin.create()</button></div>
			</div>
			<div id="query-header" class="header">
				<div class="label"><strong>query</strong> items with 
					<input id="query-prop-input" value='type'></input>
					=
					<input id="query-val-input" value='user'></input>
				</div>
				<div class="button-holder"><button id="query-button">fin.query()</button></div>
			</div>
			<div id="results-header" class="header">
				<div class="label"><strong>subscribe & mutate</strong>
					item <input id="subscribe-itemId" style="width: 30px;" value="1"></input> 
					prop <input id="subscribe-property" value="type" ></input>
				</div>
				<div class="button-holder"><button id="subscribe-button">fin.subscribe()</button></div>
			</div>
		</div>
		
		<div id="output-column" class="column">
			<div id="query-output" class="header">Results</div>
			<div></div>
		</div>
		
		<script type="text/javascript" src="../lib/js.io/packages/jsio.js"></script>
		<script type="text/javascript">

			jsio.path.client = '../js'
			jsio.path.shared = '../js'
			jsio('import client.fin')
			
			var demo = {}
			
			fin.connect(function(){ 
				var createButton = document.getElementById('create-button'),
					createPropInput = document.getElementById('create-prop-input'),
					createValInput = document.getElementById('create-val-input'),
					queryButton = document.getElementById('query-button'),
					queryPropInput = document.getElementById('query-prop-input'),
					queryValInput = document.getElementById('query-val-input'),
					subscribeIdInput = document.getElementById('subscribe-itemId'),
					subscribePropInput = document.getElementById('subscribe-property'),
					subscribeButton = document.getElementById('subscribe-button')
					
				createButton.onclick = function() {
					var properties = {},
						propName = createPropInput.value,
						propVal = createValInput.value
						
					properties[propName] = propVal
					fin.create(properties, function(newItemId) {
						var el = demo.createOutput()
						function update(newVal) { el.innerHTML = '<strong>created</strong> item ' + newItemId}
						update(propVal)
						// fin.subscribe(newItemId, propName, function(mutation) { update(mutation.args[0]) })
					})
				}
				
				queryButton.onclick = function() {
					var query = {},
						propName = queryPropInput.value,
						propVal = queryValInput.value
					
					query[propName] = propVal
					demo.query(query)
				}
				
				subscribeButton.onclick = function() {
					var itemId = subscribeIdInput.value
					var propName = subscribePropInput.value
					demo.subscribeTo(itemId, propName)
				}
				
				createPropInput.onkeyup = function() { 
					createButton.innerHTML = 'fin.create({"'+createPropInput.value+'":"'+createValInput.value+'"})' 
				}
				createValInput.onkeyup = createPropInput.onkeyup
				
				queryPropInput.onkeyup = function() { 
					queryButton.innerHTML = 'fin.query({"'+queryPropInput.value+'":"'+queryValInput.value+'"})'
				}
				queryValInput.onkeyup = queryPropInput.onkeyup
				
				subscribeIdInput.onkeyup = function() { 
					subscribeButton.innerHTML = 'fin.subscribe('+subscribeIdInput.value+',"'+subscribePropInput.value+'")'
				}
				subscribePropInput.onkeyup = subscribeIdInput.onkeyup
				
				createValInput.onkeyup()
				queryPropInput.onkeyup()
				subscribeIdInput.onkeyup()
			})
			
			demo.createOutput = function() {
				var parent = document.getElementById('output-column')
				var el = parent.insertBefore(document.createElement('div'), parent.childNodes[2])
				el.className = 'header'
				return el
			}
			
			demo.query = function(query) {
				var queryJSON = JSON.stringify(query),
					domId = 'queryId-' + queryJSON
					
				if (document.getElementById(domId)) { return }
				fin.query(query, function(mutation) { demo.onQueryUpdate(query, mutation) })
				
				var queryOutput = demo.createOutput()
				queryOutput.id = domId
				queryOutput.className += ' query-container'
				queryOutput.innerHTML = '<div><strong>queried</strong> for items with ' + queryJSON + '</div>'
			}

			demo.subscribeTo = function(itemId, propName) {
				var el = demo.createOutput()
				el.innerHTML = '<strong>subscribed</strong> to item ' + itemId + ' ' + propName + ' = <input style="width: 100px;"></input>'
				el.className += ' item'
				var input = el.getElementsByTagName('input')[0]
				fin.subscribe(itemId, propName, function(mutation, newVal) { input.value = newVal })
				input.onkeyup = function() { fin.set(itemId, propName, input.value) }
			}
			
			demo.onQueryUpdate = function(query, mutation) {
				var itemIds = mutation.args,
					queryJSON = JSON.stringify(query)
				
				for (var i=0, itemId; itemId = itemIds[i]; i++) {
					demo.queryHandlers[mutation.op](queryJSON, itemId)
				}
			}
			demo.queryHandlers = {
				sadd: function(queryJSON, itemId) {
					var queryDomId = 'queryId-' + queryJSON
					var parent = document.getElementById(queryDomId)
					var el = parent.appendChild(document.createElement('span'))
					el.id = 'queryResult-' + queryJSON + '-' + itemId
					el.innerHTML = itemId + ', '
				},
				srem: function(queryJSON, itemId) {
					var el = document.getElementById('queryResult-' + queryJSON + '-' + itemId)
					el.parentNode.removeChild(el)
				}
			}
			
		</script>
		
	</body>
</html>